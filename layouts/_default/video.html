{{ define "main" }}
<!-- Add Google Fonts -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Petrona:wght@400;500;700&family=Rosarivo:wght@400;700&family=Asul&display=swap">

<style>
    :root {
        /* Colors */
        --color-base: #fdf5ea;
        --color-contrast: #6d3a17;
        --color-accent-1: #f7ebdb;
        --color-accent-2: #e69b55;
        --color-accent-3: #c4886e;
        --color-accent-4: #686868;
        --color-accent-5: #FBFAF3;
        --color-commentary: rgba(196, 136, 110, 0.08);
        
        /* Typography */
        --font-primary: 'Petrona', serif;
        --font-heading-1: 'Rosarivo', serif;
        --font-heading-2: 'Asul', sans-serif;
        --font-size-small: 0.8rem;
        --font-size-medium: 1rem;
        --font-size-large: 1.2rem;
        --font-size-x-large: 1.6rem;
        
        /* Spacing */
        --spacing-sm: 10px;
        --spacing-md: 20px;
        --spacing-lg: 30px;
        --spacing-xl: clamp(30px, 5vw, 50px);
    }
    
    body {
        font-family: var(--font-primary);
        font-size: var(--font-size-medium);
        line-height: 1.6;
        color: var(--color-contrast);
        background-color: var(--color-base);
        margin: 0;
        padding: 0;
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--spacing-xl);
    }
    
    h1 {
        font-family: var(--font-heading-1);
        font-size: clamp(1.5rem, 1.5rem + ((1vw - 0.2rem) * 1.565), 2.5rem);
        font-weight: 700;
        line-height: 1.3;
        color: var(--color-contrast);
        margin-bottom: var(--spacing-md);
        text-align: center;
    }
    
    h2 {
        font-family: var(--font-heading-2);
        font-size: clamp(0.929rem, 0.929rem + ((1vw - 0.2rem) * 0.739), 1.4rem);
        font-weight: 400;
        line-height: 1.3;
        color: var(--color-contrast);
        text-align: center;
        margin-top: 0;
        margin-bottom: var(--spacing-lg);
    }
    
    h3 {
        font-family: var(--font-heading-2);
        font-size: var(--font-size-large);
        font-weight: 600;
        margin-top: var(--spacing-md);
        margin-bottom: var(--spacing-sm);
        color: var(--color-contrast);
    }
    
    .main-layout {
        display: grid;
        grid-template-columns: minmax(240px, 1fr) minmax(0, 3fr);
        gap: var(--spacing-lg);
    }
    
    .chapter-nav {
        position: sticky;
        top: var(--spacing-xl);
        height: fit-content;
        max-height: 80vh;
        overflow-y: auto;
        padding-right: var(--spacing-md);
    }
    
    .chapter-nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
        border-left: 2px solid var(--color-accent-1);
    }
    
    .chapter-nav li {
        margin-bottom: var(--spacing-sm);
    }
    
    .chapter-nav a {
        display: block;
        padding: var(--spacing-sm) var(--spacing-md);
        color: var(--color-contrast);
        text-decoration: none;
        border-left: 2px solid transparent;
        margin-left: -2px;
        transition: all 0.2s;
        font-size: 0.95rem;
        line-height: 1.4;
    }
    
    .chapter-nav a:hover {
        background-color: var(--color-accent-1);
    }
    
    .chapter-nav a.active {
        border-left: 2px solid var(--color-accent-2);
        background-color: var(--color-accent-1);
        font-weight: 500;
    }
    
    .chapter-timestamp {
        display: block;
        font-size: var(--font-size-small);
        color: var(--color-accent-4);
        margin-top: 4px;
    }
    
    .content-area {
        display: flex;
        flex-direction: column;
    }
    
    .video-container {
        position: relative;
        width: 100%;
        padding-top: 56.25%; /* 16:9 Aspect Ratio */
        background-color: #000;
        margin-bottom: var(--spacing-lg);
        border-radius: 5px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
    }
    
    .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        background-color: white;
        padding: var(--spacing-md);
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .chapter-title {
        font-family: var(--font-heading-2);
        font-size: var(--font-size-large);
        margin: 0;
    }
    
    .toggle-commentary {
        display: flex;
        align-items: center;
        background-color: var(--color-accent-1);
        border: none;
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: 30px;
        font-family: var(--font-heading-2);
        font-size: var(--font-size-small);
        color: var(--color-contrast);
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .toggle-commentary:hover {
        background-color: var(--color-accent-2);
        color: white;
    }
    
    .toggle-commentary::before {
        content: "";
        display: inline-block;
        width: 14px;
        height: 14px;
        background-color: var(--color-accent-3);
        border-radius: 50%;
        margin-right: 8px;
        transition: background-color 0.2s;
    }
    
    .toggle-commentary.active::before {
        background-color: #4CAF50;
    }
    
    .transcript {
        background-color: white;
        border-radius: 5px;
        padding: var(--spacing-lg);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .chapter {
        margin-bottom: var(--spacing-xl);
        padding-bottom: var(--spacing-lg);
        border-bottom: 1px solid var(--color-accent-1);
        display: none;
    }
    
    .chapter.active {
        display: block;
    }
    
    .chapter:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .chapter-header {
        margin-bottom: var(--spacing-md);
    }
    
    .chapter-time {
        font-size: var(--font-size-small);
        color: var(--color-accent-4);
    }
    
    .paragraph {
        margin-bottom: var(--spacing-lg);
        position: relative;
    }
    
    .transcript-text {
        margin-bottom: var(--spacing-md);
        position: relative;
    }
    
    .commentary-block {
        padding: var(--spacing-md);
        background-color: var(--color-commentary);
        border-left: 3px solid var(--color-accent-3);
        margin-top: var(--spacing-sm);
        font-style: italic;
        color: var(--color-contrast);
        display: none; /* Hidden by default */
        position: relative;
        border-radius: 0 5px 5px 0;
    }
    
    .show-commentary .commentary-block {
        display: block;
    }
    
    .transcript-paragraph {
        position: relative;
        margin-bottom: var(--spacing-lg);
    }
    
    .paragraph-timestamp {
        position: absolute;
        left: -60px;
        top: 0;
        color: var(--color-accent-4);
        font-size: var(--font-size-small);
        opacity: 0.8;
    }
    
    /* Marker for paragraphs with commentary */
    .has-commentary::after {
        content: "â€»";
        color: var(--color-accent-3);
        position: absolute;
        right: -20px;
        top: 0;
        font-size: var(--font-size-large);
        opacity: 0.7;
    }
    
    .show-commentary .has-commentary::after {
        display: none;
    }
    
    /* Mobile styles */
    .mobile-controls {
        display: none;
    }
    
    @media (max-width: 768px) {
        .main-layout {
            grid-template-columns: 1fr;
        }
        
        .chapter-nav {
            position: relative;
            top: 0;
            max-height: none;
            margin-bottom: var(--spacing-lg);
            display: none;
        }
        
        .chapter-nav.mobile-visible {
            display: block;
        }
        
        .paragraph-timestamp {
            position: relative;
            left: 0;
            display: block;
            margin-bottom: 4px;
        }
        
        .transcript {
            padding: var(--spacing-md);
        }
        
        .container {
            padding: var(--spacing-md);
        }
        
        .mobile-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
        }
        
        .mobile-nav-toggle {
            background-color: var(--color-accent-1);
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 5px;
            font-family: var(--font-heading-2);
            font-size: var(--font-size-small);
            color: var(--color-contrast);
            cursor: pointer;
        }
        
        .has-commentary::after {
            position: relative;
            right: auto;
            display: inline-block;
            margin-left: 5px;
        }
    }
</style>

<div class="container">
    <h1>{{ .Title }}</h1>
    <h2>{{ .Params.subtitle }}</h2>
    
    <!-- Mobile Controls -->
    <div class="mobile-controls">
        <button class="mobile-nav-toggle" id="mobileNavToggle">Show Chapter Navigation</button>
    </div>
    
    <div class="main-layout">
        <!-- Chapter Navigation -->
        <div class="chapter-nav" id="chapterNav">
            <h3>Chapters</h3>
            <ul>
                {{ range $index, $chapter := site.Data.transcripts.lama_zopa_nonsense_mind.chapters }}
                    <li>
                        <a href="#chapter-{{ $chapter.id }}" class="chapter-link{{ if eq $index 0 }} active{{ end }}" data-chapter="{{ $chapter.id }}">
                            {{ $chapter.id }}. {{ $chapter.title }}
                            <span class="chapter-timestamp">{{ div $chapter.start_time 60 | int }}:{{ mod $chapter.start_time 60 | printf "%02d" }} - {{ div $chapter.end_time 60 | int }}:{{ mod $chapter.end_time 60 | printf "%02d" }}</span>
                        </a>
                    </li>
                {{ end }}
            </ul>
        </div>
        
        <!-- Content Area -->
        <div class="content-area">
            <!-- Video Player -->
            <div class="video-container">
                <iframe id="youtube-player" 
                    src="https://www.youtube.com/embed/{{ .Params.youtube_id }}?enablejsapi=1" 
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
                </iframe>
            </div>
            
            <!-- Controls Bar -->
            <div class="controls">
                <h3 class="chapter-title" id="currentChapterTitle">
                    {{ with index site.Data.transcripts.lama_zopa_nonsense_mind.chapters 0 }}
                        {{ .id }}. {{ .title }}
                    {{ end }}
                </h3>
                <button class="toggle-commentary" id="toggleCommentary">Show Commentary</button>
            </div>
            
            <!-- Transcript Content -->
            <div class="transcript" id="transcriptContent">
                {{ range $index, $chapter := site.Data.transcripts.lama_zopa_nonsense_mind.chapters }}
                    <div id="chapter-{{ $chapter.id }}" class="chapter{{ if eq $index 0 }} active{{ end }}">
                        <div class="chapter-header">
                            <h3>{{ $chapter.id }}. {{ $chapter.title }}</h3>
                            <span class="chapter-time">{{ div $chapter.start_time 60 | int }}:{{ mod $chapter.start_time 60 | printf "%02d" }} - {{ div $chapter.end_time 60 | int }}:{{ mod $chapter.end_time 60 | printf "%02d" }}</span>
                        </div>
                        
                        <!-- Split the transcript into paragraphs -->
                        {{ $paragraphs := split $chapter.transcript "\n\n" }}
                        {{ range $pIndex, $paragraph := $paragraphs }}
                            {{ if ne (trim $paragraph " ") "" }}
                                <div class="transcript-paragraph">
                                    <!-- Calculate an approximate timestamp for the paragraph -->
                                    {{ $paraTimeOffset := mul $pIndex 20 }}
                                    {{ $paraTime := add $chapter.start_time $paraTimeOffset }}
                                    <span class="paragraph-timestamp">{{ div $paraTime 60 | int }}:{{ mod $paraTime 60 | printf "%02d" }}</span>
                                    
                                    <!-- Check if the paragraph should have commentary -->
                                    <p class="transcript-text{{ if ne $chapter.commentary "" }} has-commentary{{ end }}">
                                        {{ $paragraph | markdownify }}
                                    </p>
                                    
                                    <!-- Add commentary if available -->
                                    {{ if ne $chapter.commentary "" }}
                                        <div class="commentary-block">
                                            {{ $chapter.commentary | markdownify }}
                                        </div>
                                    {{ end }}
                                </div>
                            {{ end }}
                        {{ end }}
                    </div>
                {{ end }}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle commentary visibility
        const toggleButton = document.getElementById('toggleCommentary');
        const transcript = document.getElementById('transcriptContent');
        
        toggleButton.addEventListener('click', function() {
            transcript.classList.toggle('show-commentary');
            toggleButton.classList.toggle('active');
            
            if (transcript.classList.contains('show-commentary')) {
                toggleButton.textContent = 'Hide Commentary';
            } else {
                toggleButton.textContent = 'Show Commentary';
            }
        });
        
        // Chapter navigation
        const chapterLinks = document.querySelectorAll('.chapter-link');
        const chapters = document.querySelectorAll('.chapter');
        const currentChapterTitle = document.getElementById('currentChapterTitle');
        
        chapterLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Update active link
                chapterLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                // Update chapter visibility
                const chapterId = this.getAttribute('href');
                chapters.forEach(chapter => chapter.classList.remove('active'));
                document.querySelector(chapterId).classList.add('active');
                
                // Update current chapter title
                currentChapterTitle.textContent = this.textContent.trim().split('\n')[0];
                
                // Jump to timestamp in video
                const chapterNum = this.getAttribute('data-chapter');
                jumpToChapter(parseInt(chapterNum));
                
                // Hide mobile navigation after selection
                const chapterNav = document.getElementById('chapterNav');
                chapterNav.classList.remove('mobile-visible');
                mobileNavToggle.textContent = 'Show Chapter Navigation';
            });
        });
        
        // Mobile navigation toggle
        const mobileNavToggle = document.getElementById('mobileNavToggle');
        const chapterNav = document.getElementById('chapterNav');
        
        mobileNavToggle.addEventListener('click', function() {
            chapterNav.classList.toggle('mobile-visible');
            
            if (chapterNav.classList.contains('mobile-visible')) {
                mobileNavToggle.textContent = 'Hide Chapter Navigation';
            } else {
                mobileNavToggle.textContent = 'Show Chapter Navigation';
            }
        });
        
        // YouTube API Integration
        let youtubePlayer;
        
        // Load YouTube API
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        
        // Setup YouTube player when API is ready
        window.onYouTubeIframeAPIReady = function() {
            youtubePlayer = new YT.Player('youtube-player', {
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        };
        
        // When player is ready
        function onPlayerReady(event) {
            console.log("YouTube player is ready");
        }
        
        // When player state changes
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) {
                startTracking();
            } else {
                stopTracking();
            }
        }
        
        let trackingInterval;
        
        // Start tracking current time
        function startTracking() {
            stopTracking();
            trackingInterval = setInterval(() => {
                if (youtubePlayer && youtubePlayer.getCurrentTime) {
                    const currentTime = youtubePlayer.getCurrentTime();
                    updateActiveChapter(currentTime);
                }
            }, 1000);
        }
        
        // Stop tracking
        function stopTracking() {
            if (trackingInterval) {
                clearInterval(trackingInterval);
            }
        }
        
        // Update active chapter based on current time
        function updateActiveChapter(currentTime) {
            // Get chapter data from data attributes
            let activeChapterId = null;
            let chapterData = [];
            
            document.querySelectorAll('.chapter-link').forEach(link => {
                const chapterText = link.querySelector('.chapter-timestamp').textContent;
                const times = chapterText.match(/(\d+):(\d+) - (\d+):(\d+)/);
                if (times) {
                    const startMinutes = parseInt(times[1]);
                    const startSeconds = parseInt(times[2]);
                    const endMinutes = parseInt(times[3]);
                    const endSeconds = parseInt(times[4]);
                    
                    const startTime = startMinutes * 60 + startSeconds;
                    const endTime = endMinutes * 60 + endSeconds;
                    
                    chapterData.push({
                        id: link.getAttribute('data-chapter'),
                        start: startTime,
                        end: endTime
                    });
                }
            });
            
            // Find the active chapter
            for (let chapter of chapterData) {
                if (currentTime >= chapter.start && currentTime < chapter.end) {
                    activeChapterId = chapter.id;
                    break;
                }
            }
            
            // Update UI if we found an active chapter
            if (activeChapterId) {
                const activeLink = document.querySelector(`.chapter-link[data-chapter="${activeChapterId}"]`);
                const activeChapter = document.querySelector(`#chapter-${activeChapterId}`);
                
                // Only update if there's a change
                if (!activeLink.classList.contains('active')) {
                    // Update navigation
                    document.querySelectorAll('.chapter-link').forEach(l => l.classList.remove('active'));
                    activeLink.classList.add('active');
                    
                    // Update chapter visibility
                    document.querySelectorAll('.chapter').forEach(c => c.classList.remove('active'));
                    activeChapter.classList.add('active');
                    
                    // Update title
                    currentChapterTitle.textContent = activeLink.textContent.trim().split('\n')[0];
                }
            }
        }
        
        // Jump to specific chapter
        function jumpToChapter(chapterNum) {
            if (!youtubePlayer || !youtubePlayer.seekTo) return;
            
            // Find chapter data
            const chapterLink = document.querySelector(`.chapter-link[data-chapter="${chapterNum}"]`);
            if (chapterLink) {
                const timestampText = chapterLink.querySelector('.chapter-timestamp').textContent;
                const times = timestampText.match(/(\d+):(\d+)/);
                if (times) {
                    const minutes = parseInt(times[1]);
                    const seconds = parseInt(times[2]);
                    const targetTime = minutes * 60 + seconds;
                    
                    // Seek to time
                    youtubePlayer.seekTo(targetTime, true);
                }
            }
        }
    });
</script>
{{ end }}