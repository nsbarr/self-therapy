{{ define "main" }}
<!-- Add Google Fonts -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Petrona:wght@400;500;700&family=Rosarivo:wght@400;700&family=Asul&display=swap">

<style>
    :root {
        /* Colors */
        --color-base: #fdf5ea;
        --color-contrast: #6d3a17;
        --color-accent-1: #f7ebdb;
        --color-accent-2: #e69b55;
        --color-accent-3: #c4886e;
        --color-accent-4: #686868;
        --color-accent-5: #FBFAF3;
        
        /* Typography */
        --font-primary: 'Petrona', serif;
        --font-heading-1: 'Rosarivo', serif;
        --font-heading-2: 'Asul', sans-serif;
        --font-size-small: 0.8rem;
        --font-size-medium: 1rem;
        --font-size-large: 1.2rem;
        --font-size-x-large: 1.6rem;
        
        /* Spacing */
        --spacing-sm: 10px;
        --spacing-md: 20px;
        --spacing-lg: 30px;
        --spacing-xl: clamp(30px, 5vw, 50px);
    }
    
    body {
        font-family: var(--font-primary);
        font-size: var(--font-size-medium);
        line-height: 1.6;
        color: var(--color-contrast);
        background-color: var(--color-base);
        margin: 0;
        padding: 0;
    }
    
    body.dark-mode {
        --color-base: #1a1a1a;
        --color-contrast: #e6d2bc;
        --color-accent-1: #2a2520;
        --color-accent-2: #e69b55;
        --color-accent-3: #c4886e;
        --color-accent-4: #a8a8a8;
        --color-accent-5: #252525;
        background-color: #1a1a1a;
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--spacing-xl);
    }
    
    h1 {
        font-family: var(--font-heading-1);
        font-size: clamp(1.5rem, 1.5rem + ((1vw - 0.2rem) * 1.565), 2.5rem);
        font-weight: 700;
        line-height: 1.3;
        color: var(--color-contrast);
        margin-bottom: var(--spacing-md);
        text-align: center;
    }
    
    h2 {
        font-family: var(--font-heading-2);
        font-size: clamp(0.929rem, 0.929rem + ((1vw - 0.2rem) * 0.739), 1.4rem);
        font-weight: 400;
        line-height: 1.3;
        color: var(--color-contrast);
        text-align: center;
        margin-top: 0;
        margin-bottom: var(--spacing-lg);
    }
    
    /* Main layout */
    .content-container {
        display: flex;
        gap: var(--spacing-xl);
    }
    
    .video-section {
        flex: 0 0 40%;
        position: sticky;
        top: var(--spacing-xl);
        height: fit-content;
    }
    
    .transcript-section {
        flex: 0 0 55%;
        border: 1px solid var(--color-accent-1);
        border-radius: 5px;
        padding: var(--spacing-md);
        background-color: var(--color-accent-5);
    }
    
    .video-container {
        position: relative;
        width: 100%;
        padding-top: 56.25%; /* 16:9 Aspect Ratio */
        background-color: #000;
        margin-bottom: var(--spacing-md);
        border-radius: 5px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
    }
    
    /* Button styles */
    .control-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: var(--spacing-md);
    }
    
    .control-button {
        display: inline-block;
        font-size: var(--font-size-small);
        color: var(--color-accent-3);
        background: none;
        border: 1px solid var(--color-accent-3);
        border-radius: 30px;
        padding: 5px 12px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .control-button:hover {
        background-color: var(--color-accent-1);
    }
    
    .control-button.active {
        background-color: var(--color-accent-3);
        color: white;
    }
    
    /* Chapter styling */
    .chapter {
        margin-bottom: var(--spacing-md);
    }
    
    .chapter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--color-accent-1);
        padding: var(--spacing-md);
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .chapter-header:hover {
        background-color: var(--color-accent-2);
        color: white;
    }
    
    .chapter-title-wrapper {
        display: flex;
        flex-direction: column;
    }
    
    .chapter-title {
        margin: 0;
        font-family: var(--font-heading-2);
        font-size: var(--font-size-large);
    }
    
    .chapter-time {
        font-size: var(--font-size-small);
        color: var(--color-accent-4);
        margin-top: 4px;
    }
    
    .chapter-toggle {
        width: 20px;
        height: 20px;
        position: relative;
    }
    
    .chapter-toggle::before,
    .chapter-toggle::after {
        content: "";
        position: absolute;
        background-color: var(--color-contrast);
        transition: transform 0.3s;
    }
    
    .chapter-toggle::before {
        width: 2px;
        height: 12px;
        top: 4px;
        left: 9px;
    }
    
    .chapter-toggle::after {
        width: 12px;
        height: 2px;
        top: 9px;
        left: 4px;
    }
    
    .chapter-header.collapsed .chapter-toggle::before {
        transform: rotate(90deg);
    }
    
    .chapter-content {
        padding: var(--spacing-md);
        display: none;
        background-color: white;
        border-radius: 0 0 5px 5px;
        margin-top: 2px;
    }
    
    .chapter-content.expanded {
        display: block;
    }
    
    /* Chapter transcript and commentary */
    .chapter-transcript {
        margin-bottom: var(--spacing-lg);
    }
    
    .transcript-paragraph {
        margin-bottom: var(--spacing-sm);
        color: var(--color-contrast);
        width: 100%;
    }
    
    .commentary {
        font-style: italic;
        margin-top: var(--spacing-lg);
        padding: var(--spacing-md);
        border-left: 3px solid var(--color-accent-3);
        color: var(--color-accent-3);
        background-color: var(--color-accent-1);
        border-radius: 0 5px 5px 0;
        display: none; /* Hidden by default */
    }
    
    .show-commentary .commentary {
        display: block;
    }
    
    /* Dark mode overrides */
    body.dark-mode .chapter-content {
        background-color: #252525;
        color: #e6d2bc;
    }
    
    body.dark-mode .chapter-header {
        background-color: #333;
        color: #e6d2bc;
    }
    
    body.dark-mode .commentary {
        background-color: rgba(196, 136, 110, 0.15);
    }
    
    /* Mobile responsive styles */
    @media (max-width: 768px) {
        .content-container {
            flex-direction: column;
        }
        .video-section {
            position: sticky;
            top: 0;
            width: 100%;
            z-index: 10;
            background-color: var(--color-base);
            padding-bottom: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }
        .transcript-section {
            width: 100%;
        }
        .container {
            padding: var(--spacing-md);
        }
    }
</style>

<div class="container">
    <h1>{{ .Title }}</h1>
    <h2>{{ .Params.subtitle }}</h2>
    
    <div class="content-container">
        <!-- Video Section (Left) -->
        <div class="video-section">
            <div class="video-container">
                <iframe id="youtube-player" 
                    src="https://www.youtube.com/embed/{{ .Params.youtube_id }}?enablejsapi=1" 
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
                </iframe>
            </div>
            
            <!-- Control Buttons -->
            <div class="control-buttons">
                <button class="control-button" id="toggleCommentary">Show Commentary</button>
                <button class="control-button" id="toggleAutoScroll">Enable Auto-Scroll</button>
                <button class="control-button" id="toggleDarkMode">Dark Mode</button>
            </div>
        </div>
        
        <!-- Transcript Section (Right) -->
        <div class="transcript-section" id="transcript">
            {{ range $index, $chapter := site.Data.transcripts.lama_zopa_nonsense_mind.chapters }}
                <div id="chapter-{{ $chapter.id }}" class="chapter">
                    <div class="chapter-header{{ if eq $index 0 }} expanded{{ else }} collapsed{{ end }}" data-chapter="{{ $chapter.id }}">
                        <div class="chapter-title-wrapper">
                            <h3 class="chapter-title">{{ $chapter.id }}. {{ $chapter.title }}</h3>
                            <span class="chapter-time">{{ div $chapter.start_time 60 | int }}:{{ mod $chapter.start_time 60 | printf "%02d" }} - {{ div $chapter.end_time 60 | int }}:{{ mod $chapter.end_time 60 | printf "%02d" }}</span>
                        </div>
                        <div class="chapter-toggle"></div>
                    </div>
                    
                    <div class="chapter-content{{ if eq $index 0 }} expanded{{ end }}">
                        <div class="chapter-transcript" data-start="{{ $chapter.start_time }}" data-end="{{ $chapter.end_time }}">
                            {{ $paragraphs := split $chapter.transcript "\n\n" }}
                            {{ range $pIndex, $paragraph := $paragraphs }}
                                {{ if ne (trim $paragraph " ") "" }}
                                    <p class="transcript-paragraph">{{ $paragraph | markdownify }}</p>
                                {{ end }}
                            {{ end }}
                            
                            {{ if ne $chapter.commentary "" }}
                                <div class="commentary">
                                    {{ $chapter.commentary | markdownify }}
                                </div>
                            {{ end }}
                        </div>
                    </div>
                </div>
            {{ end }}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM elements
        const transcript = document.getElementById('transcript');
        const toggleCommentaryBtn = document.getElementById('toggleCommentary');
        const toggleAutoScrollBtn = document.getElementById('toggleAutoScroll');
        const toggleDarkModeBtn = document.getElementById('toggleDarkMode');
        const chapterHeaders = document.querySelectorAll('.chapter-header');
        const chapterContents = document.querySelectorAll('.chapter-content');
        
        // Variables
        let autoScrollEnabled = false;
        let youtubePlayer;
        
        // Chapter expand/collapse functionality (without affecting video)
        chapterHeaders.forEach(header => {
            header.addEventListener('click', function(e) {
                const chapterId = this.getAttribute('data-chapter');
                const content = document.querySelector(`#chapter-${chapterId} .chapter-content`);
                
                this.classList.toggle('collapsed');
                this.classList.toggle('expanded');
                content.classList.toggle('expanded');
                
                e.preventDefault();
                e.stopPropagation();
            });
        });
        
        // Toggle commentary
        toggleCommentaryBtn.addEventListener('click', function() {
            transcript.classList.toggle('show-commentary');
            this.classList.toggle('active');
            
            if (transcript.classList.contains('show-commentary')) {
                this.textContent = 'Hide Commentary';
            } else {
                this.textContent = 'Show Commentary';
            }
        });
        
        // Toggle auto-scroll
        toggleAutoScrollBtn.addEventListener('click', function() {
            autoScrollEnabled = !autoScrollEnabled;
            this.classList.toggle('active');
            
            if (autoScrollEnabled) {
                this.textContent = 'Disable Auto-Scroll';
            } else {
                this.textContent = 'Enable Auto-Scroll';
            }
        });
        
        // Toggle dark mode
        toggleDarkModeBtn.addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
            this.classList.toggle('active');
            
            if (document.body.classList.contains('dark-mode')) {
                this.textContent = 'Light Mode';
            } else {
                this.textContent = 'Dark Mode';
            }
        });
        
        // YouTube API integration
        let tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        let firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        
        // When YouTube API is ready
        window.onYouTubeIframeAPIReady = function() {
            youtubePlayer = new YT.Player('youtube-player', {
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        };
        
        // When player is ready
        function onPlayerReady(event) {
            // Make chapter transcripts clickable to jump to that point in the video
            const chapterTranscripts = document.querySelectorAll('.chapter-transcript');
            chapterTranscripts.forEach(transcript => {
                transcript.addEventListener('click', function() {
                    const startTime = parseInt(this.getAttribute('data-start'));
                    youtubePlayer.seekTo(startTime, true);
                    youtubePlayer.playVideo();
                });
            });
        }
        
        // Handle player state changes
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) {
                startTracking();
            } else {
                stopTracking();
            }
        }
        
        let trackingInterval;
        
        // Start tracking video time
        function startTracking() {
            stopTracking();
            trackingInterval = setInterval(() => {
                if (youtubePlayer && youtubePlayer.getCurrentTime) {
                    updateActiveChapter(youtubePlayer.getCurrentTime());
                }
            }, 1000);
        }
        
        // Stop tracking
        function stopTracking() {
            if (trackingInterval) {
                clearInterval(trackingInterval);
            }
        }
        
        // Update which chapter is active based on current time
        function updateActiveChapter(currentTime) {
            const chapters = document.querySelectorAll('.chapter');
            let activeChapter = null;
            
            chapters.forEach(chapter => {
                const transcript = chapter.querySelector('.chapter-transcript');
                const startTime = parseInt(transcript.getAttribute('data-start'));
                const endTime = parseInt(transcript.getAttribute('data-end'));
                
                if (currentTime >= startTime && currentTime < endTime) {
                    activeChapter = chapter;
                }
            });
            
            if (activeChapter) {
                // Expand the chapter if it's collapsed
                const header = activeChapter.querySelector('.chapter-header');
                const content = activeChapter.querySelector('.chapter-content');
                
                if (!content.classList.contains('expanded')) {
                    header.classList.remove('collapsed');
                    header.classList.add('expanded');
                    content.classList.add('expanded');
                }
                
                // Auto-scroll if enabled
                if (autoScrollEnabled) {
                    activeChapter.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }
        
        // Check if element is visible in viewport
        function isElementInViewport(el) {
            const rect = el.getBoundingClientRect();
            return (
                rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth)
            );
        }
    });
</script>
{{ end }}